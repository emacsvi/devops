# 矿机常用的配置

## 网络配置
由于最新的**ubuntu18**用的`netplan`来管理网络。但是我们的需求是需要一个网卡上面绑定多个网络`ip`地址。

所以还是用传统的`ifup`来管理，干掉`netplan`的管理包。命令如下：
```bash
# 安装ifup相关的工具
sudo apt install ifupdown resolvconf

# manage dns
sudo vi /etc/resolvconf/resolv.conf.d/head
nameserver 61.139.2.69
nameserver 8.8.8.8

# manage ip
auto lo
iface lo inet loopback
auto enp67s0
iface enp67s0 inet static
address 182.140.213.136
netmask 255.255.255.192
gateway 182.140.213.129
auto enp67s0:0
iface enp67s0:0 inet static
address 10.0.20.8
netmask 255.255.255.0
gateway 10.0.20.1


# start service
sudo systemctl enable resolvconf.service
sudo systemctl start resolvconf.service

# delete netplan
sudo systemctl stop systemd-networkd networkd-dispatcher systemd-networkd-wait-online systemd-resolved
sudo systemctl disable systemd-networkd networkd-dispatcher systemd-networkd-wait-online systemd-resolved
sudo systemctl mask systemd-networkd networkd-dispatcher systemd-networkd-wait-online systemd-resolved
sudo apt purge nplan netplan.io -y

# restart service
sudo systemctl restart resolvconf.service

```

## 修改hostname及ssh端口
```bash
# set hostname
sudo hostnamectl set-hostname cdxx0803
sudo vi /etc/hosts # 修改一下hostname
sudo vi /etc/ssh/sshd_config # 修改端口
sudo systemctl restart sshd.service # 重启服务
```

## fdisk格式化磁盘
格式化磁盘工具有很多，我们平时常用的fdisk基本功能就够了，只是有点慢。先慢慢学会这个工具，再去搞其他工具就触类旁通了。
```bash
# 先查看有哪些物理盘
sudo fdisk -l

# 对哪块盘做逻辑分区
sudo fdisk /dev/sda

# 对分区1做格式化
sudo mkfs.ext4 /dev/sda1

# 挂载分区1到/data/filecoin
# 先创建这个目录
sudo mkdir -p /data/filecoin
# 挂载
sudo mount /dev/sda1 /data/filecoin
# 修改权限
sudo chown -R xjgw:xjgw /data/filecoin
# 放到fstab里面，开机自启动
echo "/dev/sda1 /data/filecoin ext4 rw,noatime 0 0" | sudo tee -a /etc/fstab
```

## lsi用软件做Raid
[查看博客学习](https://blog.csdn.net/oaa608868/article/details/53523960), 或者[lsi命令](https://www.aikaiyuan.com/11557.html)
**安装megacli工具**:
```bash
# 安装megacli
# 末尾添加源
# sudo vim /etc/apt/sources.list
echo "deb http://hwraid.le-vert.net/ubuntu precise main" | tee -a /etc/apt/sources.list

# 更新源
sudo apt-get update  
# 注意：会提示一些警告可忽略，但如果提示 GPG 错误，需要执行如下命令添加证书：
sudo wget -O - http://hwraid.le-vert.net/debian/hwraid.le-vert.net.gpg.key | sudo apt-key add -
sudo apt-get update
# 安装MegaCLI
sudo apt-get install -y megacli megactl megaraid-status
# 显示Raid卡型号，Raid设置，Disk相关信息
sudo megacli -cfgdsply -aALL
```

**做raid5**：
可以参考[raid5](https://blog.51cto.com/hmtk520/2140657)
```bash
# 查看RAID状态
sudo megacli -cfgdsply -aALL
# 注意：State为Optimal，表示正常。更换损坏的硬盘后，机器会自动同步raid数据，此时状态为Degraded降级状态，不需要别的操作，只需等待几个小时待完全同步数据，恢复raid状态。
sudo megacli -cfgdsply -aALL |grep "State"

# 查看物理磁盘信息
sudo megacli -PDList -aALL

# 检测磁盘 ID 注意, 该ID 值用于标注磁盘 Enclosure Device ID: 252
sudo megacli -PDlist -aALL | grep "ID"  | uniq
# 查看当前raid数量
sudo megacli -cfgdsply -aALL |grep "Number of DISK GROUPS:"
# 查看Raid卡信息
sudo megacli -cfgdsply –aALL  | more
# 其他物理信息
sudo megacli -PDList -aALL | more
# 当前raid信息
sudo megacli -LDInfo -LALL –aAll
# raid 控制器个数
sudo megacli  -adpCount
# raid 控制器时间
sudo megacli -AdpGetTime –aALL
# https://blog.51cto.com/hmtk520/2140657

# 创建raid5 创建一个raid5阵列，由物理盘1,2,3,4,5构成，该阵列的热备盘是物理盘6
sudo megacli -CfgLdAdd -r5 [252:0,252:1,252:2,252:3,252:4] WB Direct -Hsp[252:5] –a0

Adapter 0: Created VD 0
Adapter: 0: Set Physical Drive at EnclId-252 SlotId-5 as Hot Spare Success.

Adapter 0: Configured the Adapter!!

Exit Code: 0x00

# 如果不指定热备,就取消Hsp选项，我们线上用的即是这个
sudo megacli -CfgLdAdd -r5 [252:0,252:1,252:2,252:3,252:4] WB Direct –a0
```

**创建raid 10**:
创建一个`raid10`阵列，由物理盘2,3和4,5分别做raid1，在将两组raid1做raid0
```bash
sudo megacli –CfgSpanAdd –r10 –Array0[1:2,1:3] –Array1[1:4,1:5] WB Direct -a0
```

**创建raid 0**:
随便用两块盘来做个raid0的操作：
```bash
sudo megacli -PDList -aALL
sudo megacli -PDlist -aALL | grep "ID"  | uniq
sudo megacli -CfgLdAdd -r0 [26:15,26:16] WB Direct –a0
```

**错误处理**:
`The specified physical disk does not have the appropriate attributes to complete
the requested command.` 如果发现报错，可能是系统里面的raid信息有问题，或者新加入的盘未能识别。重新删除再加载即可：
```bash
xjgw@cd-xx-012:~$ sudo megacli -CfgLdAdd -r0 [26:15,26:16] WB Direct –a0

The specified physical disk does not have the appropriate attributes to complete
the requested command.

Exit Code: 0x26
xjgw@cd-xx-012:~$ sudo megacli -cfgforeign -scan -a0

There are 1 foreign configuration(s) on controller 0.

Exit Code: 0x00
xjgw@cd-xx-012:~$ sudo megacli -cfgforeign -clear -a0

Foreign configuration 0 is cleared on controller 0.

Exit Code: 0x00
xjgw@cd-xx-012:~$ sudo megacli -cfgforeign -scan -a0

There is no foreign configuration on controller 0.

Exit Code: 0x00
xjgw@cd-xx-012:~$
xjgw@cd-xx-012:~$
xjgw@cd-xx-012:~$
xjgw@cd-xx-012:~$
xjgw@cd-xx-012:~$ sudo megacli -CfgLdAdd -r0 [26:15,26:16] WB Direct –a0

Adapter 0: Created VD 1

Adapter 0: Configured the Adapter!!

Exit Code: 0x00
```

做好之后再分区，再格式化即可：
```bash
sudo fdisk -l
sudo mkfs.ext4 /dev/sda1
```

**删除raid5**：
```bash
# 删除radi5
sudo megacli -CfgLdDel -L0 -a0
```

## 安装lotus程序环境
准备`sources.list`源的文件
```text
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ xenial main
deb-src http://mirrors.aliyun.com/ubuntu/ xenial main

deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main
deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main

deb http://mirrors.aliyun.com/ubuntu/ xenial universe
deb-src http://mirrors.aliyun.com/ubuntu/ xenial universe
deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe
deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates universe

deb http://mirrors.aliyun.com/ubuntu/ xenial-security main
deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main
deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe
deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security universe
```
执行命令
```bash
# 将上面的sources.list文件overwrite系统的文件
echo "xjgw!234"| sudo -S mv  sources.list /etc/apt/sources.list
sudo apt update
sudo apt install curl vim   net-tools  expect cifs-utils  nfs-kernel-server nfs-common -y

# 修改证明文件目录权限
sudo mkdir -p /var/tmp/filecoin-proof-parameters
sudo chown -R xjgw:xjgw /var/tmp/filecoin-proof-parameters

# 安装go
echo |sudo add-apt-repository ppa:longsleep/golang-backports
# 更新源
sudo apt update
# 安装go二进制
sudo apt-get -o Acquire::http::proxy="http://manage.xingjigangwan.com:11087" install golang-go -y
# 安装其他依赖库
sudo apt install  gcc git bzr jq pkg-config mesa-opencl-icd ocl-icd-opencl-dev -y
# 设代理
export {http,https}_proxy='http://manage.xingjigangwan.com:11087'
# 安装rust
curl https://sh.rustup.rs -sSf | sh -s -- -y

# 查看go是否安装成功, 有输出相应的go信息则安装成功
go env
go version

# 查看rust是否安装成功,有输出版本号信息则安装成功
rustc -V


# 下载lotus并且编译
git clone https://github.com/filecoin-project/lotus.git
# 进入目录
cd lotus/
# 编译
make clean && make all
sudo make install

# 查看lotus是否安装成功：
lotus -v
lotus --help
```

## 安装显卡驱动
显卡驱动用`ubuntu`自带的工具安装
```bash
sudo apt-get install -y ubuntu-drivers-common
sudo ubuntu-drivers autoinstall
# 安装完成之后需要自行重启才能生效
# 执行如下命令查看显卡使用情况
xjgw@cdxx0806:~$ nvidia-smi
Thu Apr  9 11:37:10 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.59       Driver Version: 440.59       CUDA Version: 10.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  GeForce RTX 208...  Off  | 00000000:2D:00.0 Off |                  N/A |
| 39%   49C    P0    63W / 250W |     11MiB / 11016MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
```

## 增加swap
示例中增加了一个`32G`的交换分区 [参考](https://juejin.im/post/5c2da2a151882566dc118af5)
```bash
# 查看当前分区情况
free -m

# 创建一个Swap文件
sudo mkdir /sp
sudo dd if=/dev/zero of=/sp/swap-yd.img bs=1G count=32
# 修改权限
sudo chmod 600 /sp/swap-yd.img
# 设置交换分区文件
sudo mkswap /sp/swap-yd.img
# 激活启用交换分区
sudo swapon /sp/swap-yd.img
# 添加系统引导时自启动运行
sudo echo '/sp/swap-yd.img       none     swap   sw       0      0' | sudo tee -a /etc/fstab
```

## docker安装
[docker安装](https://docs.docker.com/install/linux/docker-ce/ubuntu/)

```bash
# 安装docker
sudo apt-get update
sudo apt-get -y install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
   
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io -y
sudo systemctl start docker
sudo systemctl enable docker
sudo groupadd docker
sudo usermod -aG docker ${USER}
# 退出终端之后再进入一次 如下命令检查是否安装好
docker info
```
